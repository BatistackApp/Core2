name: üìä Code Metrics & Quality Gate

on:
  push:
    branches: [ develop ]

  # MODIFI√â : Se d√©clenche AVANT le merge pour bloquer les PRs
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

  schedule:
    - cron: '0 2 * * 1' # Tous les lundis √† 2h
  workflow_dispatch:
    inputs:
      create_issue:
        description: 'Cr√©er une issue en cas de probl√®me'
        required: false
        default: true
        type: boolean

env:
  PHP_VERSION: '8.3'

permissions:
  issues: write
  pull-requests: write
  contents: write

jobs:
  quality-gate:
    name: üö¶ Quality Gate - M√©triques & Seuils
    runs-on: ubuntu-latest
    outputs:
      quality-status: ${{ steps.quality-check.outputs.status }}
      complexity-score: ${{ steps.quality-check.outputs.complexity }}
      maintainability-score: ${{ steps.quality-check.outputs.maintainability }}
      coverage-score: ${{ steps.quality-check.outputs.coverage }}
      violations-count: ${{ steps.quality-check.outputs.violations }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick
          coverage: xdebug

      - name: üì¶ Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}-metrics
          restore-keys: |
            composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}-
            composer-${{ runner.os }}-

      - name: Create database.sqlite
        run: touch database/database.sqlite

      - name: üì¶ Install Composer dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: üì¶ Install Node dependencies
        # 'npm ci' est souvent plus rapide et plus strict pour la CI
        run: npm ci

      - name: üîß Build assets
        run: npm run build

      - name: üìÅ Create reports directory
        run: mkdir -p reports/metrics

      - name: üìä Generate PHPMetrics report
        run: |
          ./vendor/bin/phpmetrics --report-html=reports/metrics --report-json=reports/metrics/metrics.json app/

      - name: üìà Generate PHPStan analysis
        run: |
          ./vendor/bin/phpstan analyse --no-progress --error-format=json > reports/metrics/phpstan.json || true
          ./vendor/bin/phpstan analyse --no-progress --error-format=table > reports/metrics/phpstan.txt || true

      - name: Configure Laravel
        run: |
          # Note: 'secrets.GH_ENV' ne sera pas disponible pour les forks externes
          echo '${{ secrets.GH_ENV }}' > .env
          echo "DB_CONNECTION=sqlite" >> .env
          echo "DB_DATABASE=${{ github.workspace }}/database/database.sqlite" >> .env
          php artisan key:generate

      - name: Migrate Database
        run: php artisan migrate --force

      - name: üß™ Run tests with coverage
        run: |
          ./vendor/bin/pest --coverage --coverage-clover=reports/metrics/coverage.xml --coverage-html=reports/metrics/coverage

      - name: Upload Coverage Report (Codecov)
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
          files: reports/metrics/coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: üé® Check code style
        run: |
          ./vendor/bin/pint --test > reports/metrics/pint.txt || echo "Style issues detected"

      - name: üö¶ Analyze quality metrics
        id: quality-check
        run: |
          # Initialiser les variables
          QUALITY_STATUS="success"
          COMPLEXITY_SCORE=0
          MAINTAINABILITY_SCORE=0
          COVERAGE_SCORE="0.00"
          VIOLATIONS_COUNT=0

          # Analyser PHPMetrics (si le fichier JSON existe)
          if [ -f "reports/metrics/metrics.json" ]; then
            COMPLEXITY_SCORE=$(jq -r '.complexity // 0' reports/metrics/metrics.json 2>/dev/null || echo "0")
            MAINTAINABILITY_SCORE=$(jq -r '.maintainability // 0' reports/metrics/metrics.json 2>/dev/null || echo "0")
          fi

          # Analyser PHPStan
          if [ -f "reports/metrics/phpstan.json" ]; then
            VIOLATIONS_COUNT=$(jq '.totals.file_errors // 0' reports/metrics/phpstan.json 2>/dev/null || echo "0")
          fi

          # Analyser la Couverture de Test (Clover XML) - CORRIG√â
          if [ -f "reports/metrics/coverage.xml" ]; then
            # Utiliser xmllint pour parser correctement le XML
            # Chercher la balise <metrics> au niveau du projet (pas des fichiers individuels)
            COVERED_STATEMENTS=$(xmllint --xpath "string(//project/metrics/@coveredstatements)" reports/metrics/coverage.xml 2>/dev/null || echo "0")
            TOTAL_STATEMENTS=$(xmllint --xpath "string(//project/metrics/@statements)" reports/metrics/coverage.xml 2>/dev/null || echo "0")

            # Alternative si xmllint n'est pas disponible : utiliser grep/sed de fa√ßon plus pr√©cise
            if [ -z "$COVERED_STATEMENTS" ] || [ "$COVERED_STATEMENTS" = "0" ]; then
              # Parser la ligne contenant les m√©triques du projet
              PROJECT_METRICS=$(grep '<metrics ' reports/metrics/coverage.xml | head -1)
              if [ -n "$PROJECT_METRICS" ]; then
                COVERED_STATEMENTS=$(echo "$PROJECT_METRICS" | sed -n 's/.*coveredstatements="\([0-9]*\)".*/\1/p')
                TOTAL_STATEMENTS=$(echo "$PROJECT_METRICS" | sed -n 's/.*statements="\([0-9]*\)".*/\1/p')
              fi
            fi

            # Calculer le pourcentage
            if [ -n "$TOTAL_STATEMENTS" ] && [ "$TOTAL_STATEMENTS" -ne "0" ] && [ "$TOTAL_STATEMENTS" != "" ]; then
              COVERAGE_SCORE=$(awk "BEGIN {printf \"%.2f\", ($COVERED_STATEMENTS / $TOTAL_STATEMENTS) * 100}")
            else
              COVERAGE_SCORE="0.00"
            fi

            echo "üîç Debug Coverage:"
            echo "  - Covered: $COVERED_STATEMENTS"
            echo "  - Total: $TOTAL_STATEMENTS"
          else
            echo "‚ö†Ô∏è Fichier coverage.xml non trouv√©"
          fi

          # D√©finir les seuils de qualit√©
          MAX_VIOLATIONS=10
          MAX_COMPLEXITY=10
          MIN_COVERAGE=70 # Seuil de couverture

          # V√©rifier les seuils
          echo "üìä M√©triques de qualit√©:"
          echo "- Violations PHPStan: ${VIOLATIONS_COUNT} (max: ${MAX_VIOLATIONS})"
          echo "- Complexit√© moyenne: ${COMPLEXITY_SCORE} (max: ${MAX_COMPLEXITY})"
          echo "- Couverture de test: ${COVERAGE_SCORE}% (min: ${MIN_COVERAGE}%)"

          if (( VIOLATIONS_COUNT > MAX_VIOLATIONS )); then
            echo "‚ùå Trop de violations PHPStan: ${VIOLATIONS_COUNT} > ${MAX_VIOLATIONS}"
            QUALITY_STATUS="failed"
          fi

          # V√©rification de la couverture (compare les flottants)
          if awk -v cov="$COVERAGE_SCORE" -v min="$MIN_COVERAGE" 'BEGIN {exit !(cov < min)}'; then
            echo "‚ùå Couverture de test insuffisante: ${COVERAGE_SCORE}% < ${MIN_COVERAGE}%"
            QUALITY_STATUS="failed"
          fi

          # Exporter les r√©sultats
          echo "status=$QUALITY_STATUS" >> $GITHUB_OUTPUT
          echo "complexity=$COMPLEXITY_SCORE" >> $GITHUB_OUTPUT
          echo "maintainability=$MAINTAINABILITY_SCORE" >> $GITHUB_OUTPUT
          echo "violations=$VIOLATIONS_COUNT" >> $GITHUB_OUTPUT
          echo "coverage=$COVERAGE_SCORE" >> $GITHUB_OUTPUT

          # Cr√©er un r√©sum√© d√©taill√©
          cat > reports/metrics/quality-summary.md << EOF
          # üìä Rapport de Qualit√© - $(date)

          ## üéØ Statut Global: $([ "$QUALITY_STATUS" = "success" ] && echo "‚úÖ SUCC√àS" || echo "‚ùå √âCHEC")

          ## üìà M√©triques Principales
          - **Violations PHPStan**: ${VIOLATIONS_COUNT} $([ $VIOLATIONS_COUNT -le $MAX_VIOLATIONS ] && echo "‚úÖ" || echo "‚ùå")
          - **Couverture de test**: ${COVERAGE_SCORE}% $(awk -v cov="$COVERAGE_SCORE" -v min="$MIN_COVERAGE" 'BEGIN {exit (cov < min) ? 1 : 0}' && echo "‚úÖ" || echo "‚ùå")
          - **Complexit√© moyenne**: ${COMPLEXITY_SCORE}

          ## üìÅ Structure du Projet
          EOF
          echo "- Fichiers PHP: $(find app/ -name "*.php" | wc -l)" >> reports/metrics/quality-summary.md
          echo "- Fichiers de tests: $(find tests/ -name "*.php" | wc -l)" >> reports/metrics/quality-summary.md

          # √âchec si quality gate √©choue
          if [ "$QUALITY_STATUS" = "failed" ]; then
            echo "üö´ Quality Gate √©chou√© - Les seuils de qualit√© ne sont pas respect√©s"
            exit 1
          fi

      - name: üì§ Upload metrics artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-metrics-${{ github.sha }}
          path: reports/metrics/
          retention-days: 30

      - name: üìä Comment PR with metrics
        # MODIFI√â : Ne s'ex√©cute que sur les PRs, et 'always()' pour poster m√™me si le gate √©choue
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = 'reports/metrics/quality-summary.md';

            if (fs.existsSync(path)) {
              const summary = fs.readFileSync(path, 'utf8');

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## üìä Rapport de Qualit√© du Code\n\n${summary}\n\n---\n*G√©n√©r√© automatiquement par le workflow Code Metrics*`
              });
            }

  notifications:
    name: üì¢ Notifications
    runs-on: ubuntu-latest
    needs: quality-gate
    if: always() && (needs.quality-gate.outputs.quality-status == 'failed')
    steps:
      - name: üî¥ Create GitHub Issue on failure
        if: needs.quality-gate.outputs.quality-status == 'failed' && (github.event.inputs.create_issue == 'true' || github.event.inputs.create_issue == '')
        uses: actions/github-script@v8
        with:
          script: |
            const title = `üö® Quality Gate Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `## üö´ Quality Gate Failure

            Le workflow de m√©triques de code a √©chou√© sur la branche \`${{ github.ref_name }}\`.

            ### üìä M√©triques
            - **Violations PHPStan**: ${{ needs.quality-gate.outputs.violations-count }}
            - **Couverture**: ${{ needs.quality-gate.outputs.coverage-score }}%
            - **Complexit√©**: ${{ needs.quality-gate.outputs.complexity-score }}

            ### üîó Liens
            - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})

            ### üìã Actions Requises
            - [ ] Corriger les violations
            - [ ] Am√©liorer la couverture de test
            - [ ] Relancer le workflow apr√®s corrections

            ---
            *Issue cr√©√©e automatiquement par le workflow Code Metrics*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['quality', 'metrics', 'bug']
            });

  summary:
    name: üìã R√©sum√© Final
    runs-on: ubuntu-latest
    needs: [quality-gate] # 'notifications' n'est pas requis ici
    if: always()
    steps:
      - name: üìã Generate workflow summary
        run: |
          echo "## üìä R√©sum√© Code Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üéØ Statut: ${{ needs.quality-gate.outputs.quality-status == 'success' && '‚úÖ SUCC√àS' || '‚ùå √âCHEC' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìà M√©triques:" >> $GITHUB_STEP_SUMMARY
          echo "- **Violations**: ${{ needs.quality-gate.outputs.violations-count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Couverture**: ${{ needs.quality-gate.outputs.coverage-score }}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Complexit√©**: ${{ needs.quality-gate.outputs.complexity-score }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÖ Ex√©cut√© le: $(date)" >> $GITHUB_STEP_SUMMARY
