name: ðŸ—ï¸ CI Modulaire (Validation PR)

on:
  pull_request:
    branches: [ modules/**, production ]
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:
    inputs:
      modules:
        description: 'Modules Ã  tester (sÃ©parÃ©s par des espaces)'
        required: false
        default: 'auto-detect'
      test_type:
        description: 'Type de test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - tests-only
          - performance-only
          - quality-only

env:
  PHP_VERSION: '8.3'
  NODE_VERSION: '20'

permissions:
  issues: write
  pull-requests: write
  contents: write # Requis pour 'actions/checkout' pour le diff

jobs:
  detect-changes:
    name: ðŸ” DÃ©tection des modules modifiÃ©s (PR)
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.detect.outputs.modules }}
      modules-json: ${{ steps.detect.outputs.modules-json }}
      has-changes: ${{ steps.detect.outputs.has-changes }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5
        with:
          # Nous avons besoin de fetch la branche de base et la branche de PR
          fetch-depth: 0

      - name: ðŸ” DÃ©tecter les modules modifiÃ©s
        id: detect
        run: |
          # DÃ©tection manuelle via workflow_dispatch
          if [[ "${{ github.event.inputs.modules }}" != "" && "${{ github.event.inputs.modules }}" != "auto-detect" ]]; then
            modules_input="${{ github.event.inputs.modules }}"
            echo "modules=$modules_input" >> $GITHUB_OUTPUT
            modules_json=$(echo "$modules_input" | sed 's/ /","/g' | sed 's/^/["/' | sed 's/$/"]/')
            echo "modules-json=$modules_json" >> $GITHUB_OUTPUT
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "Mode manuel : test des modules $modules_input"
            exit 0
          fi

          # DÃ©tection automatique des changements sur la PR
          # CORRECTION : Compare la branche de base (base_ref) avec la branche de la PR (head_ref)
          echo "Comparaison de origin/${{ github.base_ref }}...origin/${{ github.head_ref }}"
          changed_files=$(git diff --name-only origin/${{ github.base_ref }}...origin/${{ github.head_ref }} 2>/dev/null || echo "")

          if [ -z "$changed_files" ]; then
            echo "Aucun fichier modifiÃ© dÃ©tectÃ©."
            echo "has-changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Fichiers modifiÃ©s :"
          echo "$changed_files"

          modules=()

          if echo "$changed_files" | grep -E "(app/Models/Chantiers/|app/Livewire/Chantier|app/Enums/Chantiers/|tests/.*Chantier)" > /dev/null; then
            modules+=("chantiers")
          fi
          if echo "$changed_files" | grep -E "(app/Models/RH/|app/Livewire/Humans/|app/Enums/RH/|app/Actions/RH/|tests/.*RH)" > /dev/null; then
            modules+=("rh")
          fi
          if echo "$changed_files" | grep -E "(app/Models/Tiers/|app/Livewire/Tiers/|app/Enums/Tiers/|tests/.*Tiers)" > /dev/null; then
            modules+=("tiers")
          fi
          if echo "$changed_files" | grep -E "(app/Models/Commerce/|app/Enums/Commerce/|tests/.*Commerce)" > /dev/null; then
            modules+=("commerce")
          fi
          if echo "$changed_files" | grep -E "(app/Models/Produit/|app/Livewire/Produit/|app/Enums/Produits/|app/Actions/Produit/|tests/.*Produit)" > /dev/null; then
            modules+=("produit")
          fi
          if echo "$changed_files" | grep -E "(app/Models/Core/|app/Livewire/Core/|app/Enums/Core/|tests/.*Core)" > /dev/null; then
            modules+=("core")
          fi

          # Si un fichier 'core' (ex: provider, config) est modifiÃ©, tester tous les modules
          if echo "$changed_files" | grep -E "(app/Providers/|config/|routes/|bootstrap/)" > /dev/null; then
            echo "Changement 'core' dÃ©tectÃ©. Test de tous les modules."
            modules=("chantiers" "rh" "tiers" "commerce" "produit" "core")
          fi

          if [ ${#modules[@]} -eq 0 ]; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "Aucun module applicatif impactÃ©."
          else
            # Rendre la liste unique
            unique_modules=($(echo "${modules[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' '))
            echo "modules=${unique_modules[*]}" >> $GITHUB_OUTPUT

            modules_json="["
            for i in "${!unique_modules[@]}"; do
              if [ $i -gt 0 ]; then
                modules_json+=","
              fi
              modules_json+="\"${unique_modules[$i]}\""
            done
            modules_json+="]"

            echo "modules-json=$modules_json" >> $GITHUB_OUTPUT
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "Modules impactÃ©s : ${unique_modules[*]}"
          fi

  setup:
    name: âš™ï¸ Configuration (PHP & Node)
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.has-changes == 'true'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick, imap
          coverage: xdebug

      - name: ðŸ“¦ Cache Composer dependencies (Inter-run)
        id: composer-cache
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-

      - name: ðŸŽ¯ Install Composer dependencies
        if: steps.composer-cache.outputs.cache-hit != 'true'
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: ðŸ’¾ Upload vendor artifact (Intra-run)
        uses: actions/upload-artifact@v4
        with:
          name: vendor-${{ github.sha }}
          path: vendor
          retention-days: 1

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Node dependencies
        run: npm ci

      - name: ðŸ”§ Build assets
        run: npm run build

      - name: ðŸ’¾ Upload public artifact (Intra-run)
        uses: actions/upload-artifact@v4
        with:
          name: public-${{ github.sha }}
          path: public/build
          retention-days: 1

  tests:
    name: ðŸ§ª Tests - ${{ matrix.module }} (PR)
    runs-on: ubuntu-latest
    needs: [detect-changes, setup]
    if: needs.detect-changes.outputs.has-changes == 'true' && (github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'tests-only')
    strategy:
      fail-fast: false # Ne pas annuler les autres tests si un module Ã©choue
      matrix:
        module: ${{ fromJson(needs.detect-changes.outputs.modules-json) }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick, imap
          coverage: xdebug

      - name: ðŸ’¾ Download vendor artifact
        uses: actions/download-artifact@v4
        with:
          name: vendor-${{ github.sha }}
          path: vendor

      - name: ðŸ“‹ Copy environment file
        run: echo '${{ secrets.GH_ENV }}' > .env

      - name: ðŸ”‘ Generate application key
        run: php artisan key:generate

      - name: ðŸ—ƒï¸ Run migrations
        run: php artisan migrate --force

      - name: ðŸ§ª Run tests for ${{ matrix.module }}
        run: |
          # Tests stricts si la PR cible 'production'
          if [[ "${{ github.base_ref }}" == "production" ]]; then
            echo "Mode strict (cible: production)"
            ./vendor/bin/pest --coverage --coverage-clover=coverage-${{ matrix.module }}.xml --group=${{ matrix.module }} --stop-on-failure
          else
            echo "Mode normal (cible: ${{ github.base_ref }})"
            ./vendor/bin/pest --coverage --coverage-clover=coverage-${{ matrix.module }}.xml --group=${{ matrix.module }}
          fi

      - name: ðŸ“Š Upload coverage reports
        if: always() # Toujours uploader, mÃªme si les tests Ã©chouent
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.module }}
          path: coverage-${{ matrix.module }}.xml
          retention-days: 7

  performance:
    name: âš¡ Tests de performance (PR)
    runs-on: ubuntu-latest
    needs: [detect-changes, setup]
    if: needs.detect-changes.outputs.has-changes == 'true' && (github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'performance-only')
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick, imap

      - name: ðŸ’¾ Download vendor artifact
        uses: actions/download-artifact@v4
        with:
          name: vendor-${{ github.sha }}
          path: vendor

      - name: ðŸ“‹ Copy environment file
        run: echo '${{ secrets.GH_ENV }}' > .env

      - name: ðŸ”‘ Generate application key
        run: php artisan key:generate

      - name: ðŸ—ƒï¸ Run migrations
        run: php artisan migrate --force

      - name: âš¡ Run performance tests
        run: |
          if [[ "${{ github.base_ref }}" == "production" ]]; then
            ./vendor/bin/pest tests/Performance/ --group=performance --stop-on-failure
          else
            ./vendor/bin/pest tests/Performance/ --group=performance
          fi

  quality:
    name: ðŸ“Š QualitÃ© du code (PR)
    runs-on: ubuntu-latest
    needs: [detect-changes, setup]
    if: needs.detect-changes.outputs.has-changes == 'true' && (github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'quality-only')
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick, imap

      - name: ðŸ’¾ Download vendor artifact
        uses: actions/download-artifact@v4
        with:
          name: vendor-${{ github.sha }}
          path: vendor

      - name: ðŸŽ¨ Check code style
        run: |
          # Le style doit TOUJOURS Ãªtre respectÃ©, quelle que soit la branche
          ./vendor/bin/pint --test

      - name: ðŸ” Static analysis
        run: |
          # L'analyse statique doit TOUJOURS Ãªtre respectÃ©e
          ./vendor/bin/phpstan analyse --no-progress --error-format=github

      - name: ðŸ”§ Check for refactoring opportunities
        if: github.base_ref != 'production'
        run: ./vendor/bin/rector --dry-run || echo "ðŸ’¡ OpportunitÃ©s de refactoring disponibles"

  summary:
    name: ðŸ“‹ RÃ©sumÃ© des tests (PR)
    runs-on: ubuntu-latest
    needs: [detect-changes, tests, performance, quality]
    if: always() && needs.detect-changes.outputs.has-changes == 'true'
    steps:
      - name: ðŸ“‹ GÃ©nÃ©rer le rÃ©sumÃ©
        run: |
          echo "## ðŸ“Š RÃ©sumÃ© CI - PR #${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Cible: ${{ github.base_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—ï¸ Modules testÃ©s: ${{ needs.detect-changes.outputs.modules }}" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“… Date: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“Š RÃ©sultats:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª Tests: ${{ needs.tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ Performance: ${{ needs.performance.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š QualitÃ©: ${{ needs.quality.result }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.tests.result }}" == "success" && "${{ needs.performance.result }}" == "success" && "${{ needs.quality.result }}" == "success" ]]; then
            echo "âœ… **Statut Global: SUCCÃˆS**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Statut Global: Ã‰CHEC**" >> $GITHUB_STEP_SUMMARY
          fi
