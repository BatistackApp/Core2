name: ğŸ—ƒï¸ Synchronisation SchÃ©ma BDD

on:
  pull_request:
    types: [opened, synchronize, reopened]
    # Limiter aux chemins pour ne pas l'exÃ©cuter inutilement
    paths:
      - 'database/migrations/**'
      - 'app/**' # NÃ©cessaire si les modÃ¨les affectent le schÃ©ma

permissions:
  # Requis pour pouvoir pusher le commit sur la branche de la PR
  contents: write

jobs:
  sync-schema:
    name: ğŸ—ƒï¸ Dump SchÃ©ma
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5
        # Important : on checkout la branche de la PR, pas la branche de base
        with:
          ref: ${{ github.head_ref }}

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3' # Assurez-vous que c'est la bonne version
          extensions: dom, curl, libxml, mbstring, zip, pdo, sqlite, pdo_sqlite
          tools: composer:v2

      - name: ğŸ“¦ Cache Composer dependencies
        id: composer-cache
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-

      - name: ğŸ¯ Install Composer dependencies
        if: steps.composer-cache.outputs.cache-hit != 'true'
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: ğŸ“‹ Setup .env for schema dump
        run: |
          cp .env.example .env
          # Forcer SQLite en mÃ©moire/fichier pour la migration
          echo "DB_CONNECTION=sqlite" >> .env
          echo "DB_DATABASE=:memory:" >> .env
          touch database/database.sqlite

      - name: ğŸ”‘ Generate application key
        run: php artisan key:generate

      - name: ğŸ—ƒï¸ Run migrations to build schema
        run: php artisan migrate --force

      - name: ğŸ’¾ Dump Schema
        run: |
          # --prune efface les anciens dumps pour garder le repo propre
          php artisan schema:dump --prune

      - name: ğŸ¤– Commit Schema changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Mettre Ã  jour le schÃ©ma de la base de donnÃ©es"
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "github-actions@github.com"
          commit_author: "GitHub Actions Bot <github-actions@github.com>"
          # Limiter au fichier/dossier de schÃ©ma
          file_pattern: "database/schema/*.sql"
