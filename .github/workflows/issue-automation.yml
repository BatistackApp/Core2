name: üéØ Gestion des Issues

on:
  issues:
    types: [opened, labeled] # On enl√®ve 'assigned'

permissions:
  issues: write
  pull-requests: read

jobs:
  # Job 1: S'ex√©cute SEULEMENT quand une issue est "ouverte"
  auto-label-on-open:
    name: üè∑Ô∏è Labels (Complexit√© + Priorit√©)
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'

    steps:
      - name: Add Complexity + Priority Labels
        uses: actions/github-script@v8
        with:
          # On utilise le token GITHUB_TOKEN natif
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const body = (context.payload.issue.body || '').toLowerCase();
            const title = context.payload.issue.title.toLowerCase();
            const labels = context.payload.issue.labels.map(l => l.name.toLowerCase());

            const labelsToAdd = [];

            // --- Logique de Complexit√© (Corrig√©e) ---
            // On v√©rifie si une complexit√© est d√©j√† l√†
            if (!labels.some(l => l.startsWith('complexity:'))) {
              let complexity = 'complexity:medium'; // D√©faut

              // High d'abord
              if (body.includes('migration') || body.includes('api') ||
                  body.includes('integration') || title.includes('architecture') ||
                  body.includes('base de donn√©es') || body.includes('s√©curit√©') ||
                  title.includes('refactoring') || body.includes('performance')) {
                complexity = 'complexity:high';
              }
              // Low ensuite, si high n'a pas match√©
              else if (body.includes('documentation') || body.includes('css') ||
                       title.includes('fix') || title.includes('typo') ||
                       body.includes('traduction') || title.includes('style') ||
                       body.includes('texte') || title.includes('libell√©')) {
                complexity = 'complexity:low';
              }
              labelsToAdd.push(complexity);
            }

            // --- Logique de Priorit√© (Corrig√©e) ---
            // On v√©rifie si une priorit√© est d√©j√† l√†
            if (!labels.some(l => l.startsWith('priorite:'))) {
              let priority = 'priorite:moyenne'; // D√©faut

              // High d'abord
              if ((labels.includes('bug') && (body.includes('critique') || body.includes('bloque') || body.includes('production') || title.includes('urgent'))) ||
                  (labels.includes('enhancement') && (body.includes('client') || body.includes('urgent') || title.includes('important')))) {
                priority = 'priorite:haute';
              }
              // Low ensuite, si high n'a pas match√©
              else if (body.includes('documentation') || title.includes('typo') ||
                       title.includes('style') || labels.includes('good first issue')) {
                priority = 'priorite:basse';
              }
              labelsToAdd.push(priority);
            }

            if (labelsToAdd.length > 0) {
              console.log(`Ajout des labels: ${labelsToAdd.join(', ')}`);
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: labelsToAdd
              });
            } else {
              console.log('Aucun label de triage √† ajouter.');
            }

  # Job 2: S'ex√©cute SEULEMENT quand un label est "ajout√©"
  auto-assign-module:
    name: üìã Attribution par module
    runs-on: ubuntu-latest
    if: github.event.action == 'labeled'

    steps:
      - name: Auto-assign based on module label
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const moduleAssignments = {
              'module:chantiers': ['dev-chantiers'],
              'module:rh': ['dev-rh'],
              'module:commerce': ['dev-commerce'],
              'module:tiers': ['dev-tiers'],
              'module:infrastructure': ['dev-infra'],
              'module:produits-services': ['dev-commerce'],
              'module:gpao': ['dev-production'],
              'module:facturation': ['dev-finance'],
              'transversal:infra': ['devops'],
              'transversal:ux': ['designer']
            };

            // On r√©cup√®re le label qui vient d'√™tre ajout√©
            const addedLabel = context.payload.label.name.toLowerCase();
            console.log(`Label ajout√©: ${addedLabel}`);

            if (moduleAssignments[addedLabel]) {
              const assignees = moduleAssignments[addedLabel];
              console.log(`Attribution pour ${addedLabel}:`, assignees);
              try {
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number,
                  assignees: assignees
                });
                console.log('Attribution r√©ussie');
              } catch (error) {
                console.log('Erreur lors de l\'attribution:', error.message);
              }
            } else {
              console.log('Ce label ne d√©clenche pas d\'attribution.');
            }
